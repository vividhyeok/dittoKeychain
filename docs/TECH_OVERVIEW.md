# Ditto Keychain — 기술 개요 (2025.10 기준)

현장에서 디지털 이미지를 실물 키링으로 즉시 제작하는 모바일 최적화 웹앱입니다. 참가자와 스태프의 플로우를 명확히 분리하고, QR 코드에는 짧은 토큰만 담고 작품 상태는 엣지 저장소(Vercel KV 등)에 보존하여 빠르고 안정적으로 전달·재현합니다. 최근 리팩터링으로 3D 미리보기 대신 “실제 인쇄 배치”에 집중한 2D 프린트 프리뷰, 모바일 터치 제스처, 배경 색상 편집 등 사용성을 강화했습니다.

## 핵심 특성

- **역할 기반 라우팅** – 참가자(`/p/*`)와 스태프(`/s/*`)는 완전히 다른 네비게이션과 화면을 사용합니다.
- **토큰 기반 QR 전송** – 편집 상태를 JSON 직렬화 → LZ 압축 후 엣지 저장소에 저장하고 토큰만 QR에 내장, 스태프는 토큰으로 서버에서 데이터를 불러옵니다.
- **정확한 인쇄 미리보기** – mm 단위 규격(300 DPI)과 트림/세이프 가이드를 지켜 화면·출력 일치를 보장합니다.
- **모바일 퍼스트 UI** – 탭·스와이프·핀치 기반 제스처, 하단 컨트롤 데크, 색상 팔레트 등 모바일 조작을 우선 고려했습니다.

## 최신 편집기 하이라이트

- **프린트 프리뷰 전용 Stage**: 각 파트를 mm 단위로 배치하여 접었을 때의 레이아웃을 그대로 확인할 수 있습니다. 미니 CD의 앞/뒤 패널은 간격 없이 이어 붙여 실제 접힘 간섭을 줄였습니다.
- **뷰어 제스처 지원**: 프리뷰 영역을 단계별 확대(최대 3×), 드래그(터치/마우스)로 이동할 수 있으며 view 패널에서 좌표·배율을 직접 확인하고 초기화할 수 있습니다.
- **하단 컨트롤 패널**: `화면 조정 · 이미지 조정 · 배경 색상 · 이미지 불러오기 · 작업 기록`으로 탭화하여 필요한 툴을 단계적으로 노출합니다. 각 패널은 뒤로가기 버튼과 상태 뱃지를 제공합니다.
- **배경 색상 워크플로우**: 이미지 없이 단색 채우기, EyeDropper(지원 브라우저)로 화면 색 추출, 흰색 초기화/색 제거, 최근 다른 파트 색상 스와치 복사 등이 가능해졌습니다.
- **슬롯 배경/가이드 개선**: `Slot` 컴포넌트가 `bgColor`를 인식하여 이미지를 제거해도 보이는 채우기가 유지됩니다. 뒷면 가이드는 직사각형 라인으로, 디스크는 중앙 타공 표시를 유지합니다.

## 프로젝트 구조

```
src/
  components/
    ImageEditor.tsx    # 모바일 프린트 프리뷰, 컨트롤 패널, QR 생성기
    Slot.tsx           # mm 기반 슬롯, 가이드 및 드래그/핀치 제스처
    Navbar.tsx         # 역할별 네비게이션 탭, 완료 트리거
  hooks/
    useImageEditor.ts  # 파트 스펙 상태, 히스토리, 단축키 관리
    useIsMobile.ts
  pages/
    EditCd3.tsx, Edit4x5.tsx 등 편집 엔트리
    Scan*, FourUp, Staff* 등 스태프 도구
  utils/
    printSpecs.ts      # 4×5 & 미니CD 규격, mm→px 변환
    encode.ts, gesture.ts, constants.ts...
public/
  ... 정적 자산, 프린트 템플릿
```

주요 규격(`printSpecs.ts`)

- 용지: 100×148 mm (엽서)
- 4×5 키링: 트림 40×50 mm · 뷰포트 35×45 mm · 블리드 44×54 mm
- 미니 CD 케이스: 앞 40×40, 뒤 49×37, 스파인 5×37(3칸), 안쪽 44×37
- 미니 CD 디스크: 트림 Ø40, 블리드 Ø44, 홀 Ø5.5
- DPI 300, GAP(미리보기 타일 간격) 4 mm, 기본 인쇄 보정 `scaleX/Y=0.95`

## 라우팅 개요

**참가자**

- `/` 역할 선택
- `/p/cd` → `/p/cd/edit` (미니 CD 편집)
- `/p/4x5` → `/p/4x5/edit` (4×5 편집)

**스태프**

- `/s` 홈, `/s/load` 수동 로드
- `/s/scan2`, `/s/scan4` QR 스캔 워크플로우
- `/s/4up` 4×5 배치 인쇄, `/s/cd` 미니 CD 3-up 인쇄
- `/s/guide` 안전/인쇄 안내

상단 `Navbar`는 역할별 탭/완료 버튼을 제공하며, 인쇄/엑스포트 화면에서는 UI가 사라집니다.

## 기술 스택

- **UI**: React 18, TypeScript, Tailwind CSS, CSS Modules 없이 유틸리티 기반 컴포지션
- **빌드**: Vite, PostCSS/Autoprefixer, ESLint, TypeScript strict
- **라우팅**: react-router-dom v6
- **QR & 압축**: `qrcode`, `@zxing/library`, `lz-string`
- **백엔드**: Vercel Edge Functions, Vercel KV(또는 Upstash Redis KV) – 토큰/페이로드 저장
- **제스처**: Pointer 이벤트 기반 커스텀 훅 (`useGesture`)

## 데이터 흐름 (토큰 기반 QR)

1. `PartSpec` 맵을 JSON 직렬화 (`useImageEditor`).
2. `encodePayload`가 LZ 압축 → base64url 인코딩하여 최소화된 페이로드를 생성합니다.
3. 참가자 화면의 QR 생성 버튼이 `POST /api/payload`(Vercel Edge Function)로 페이로드를 업로드합니다.
4. 서버는 난수 토큰을 키로 사용하여 Vercel KV(또는 호환 저장소)에 저장하고 `{ token, url }`을 반환합니다.
5. 프런트는 반환된 URL(`https://ditto-keychain.vercel.app/s/load?token=...`)만 QR 이미지에 렌더링합니다.
6. 스태프 페이지는 QR 스캔(`@zxing/library`) 또는 수동 입력을 통해 토큰을 확보하고 `GET /api/payload?token=...`으로 작품을 읽어 복원합니다.
7. 출력/배치는 스태프 페이지에서 진행(4×5 또는 CD 레이아웃)하며, 작품 사용 후 `DELETE /api/payload?token=...`으로 정리합니다.

`PartSpec`에는 이미지 변환 값(tx/ty/scale/rot)과 `bgColor`가 포함되어 단색 필도 공유됩니다. 서버 단에서는 토큰 TTL과 해시 검증으로 무결성과 보안을 보조합니다.

## 토큰 백엔드 구성

- 호스팅: Vercel Edge Function(또는 Cloudflare Workers) + KV 저장소(Upstash, Vercel KV 등)
- 엔드포인트: `POST /api/payload`(저장), `GET /api/payload`(조회), `DELETE /api/payload`(선택적 정리)
- 보안: 앱 시크릿 헤더 검증, 토큰 TTL 만료 정책, 필요 시 IP 레이트 리밋
- 운영: 이벤트 종료 후 KV 정리 스크립트, 스태프 UI에서 삭제/갱신 버튼 옵션

## 인쇄 파이프라인

- mm→px 변환 (기본 300 DPI)으로 인쇄 크기 오차 최소화
- 트림(빨강)/세이프(파랑) 라인과 디스크 홀 표시로 컷팅 안전 확보
- 스태프 4-up/3-up 화면에서 PDF/인쇄 준비, 프린터 배율 100% 고정 권장
- `PRINT_CAL.scaleX/Y` 조정으로 프린터 overscan 대비 (현장 캘리브레이션)

## 빌드 & 런북

- 개발 서버: `npm run dev`
- 프로덕션 빌드: `npm run build`
- 빌드 미리보기: `npm run preview`

모바일 카메라 접근을 위해 HTTPS 환경, 프린터 드라이버와 용지 설정을 사전 준비합니다.

## 향후 개선 아이디어

1. **인쇄 보정 UI** – 스태프용 여백/배율 슬라이더 노출
2. **4×5 뒤편 옵션** – 미러/오프셋 토글로 봉제 방향 대응
3. **CD 내보내기 고도화** – 3-up PDF/PNG 내보내기 버튼 정식화
4. **이미지 캐싱** – 외부 이미지 CORS 폴백 및 오프라인 대비 전략
5. **접근성 & 안내** – 카메라 권한 튜토리얼, 대기표/보조 리소스 마련

## 주요 리스크 & 대응

- **프린터 자동 확대** → 배율 100% 고정, 필요 시 `scaleX/Y` 보정
- **카메라 권한 거부** → HTTPS 접속 및 브라우저 권한 안내 준비
- **외부 이미지 차단** → 현장 촬영 유도 또는 프록시/캐시 도입 검토
- **현장 혼잡** → 대기표/타임슬롯 운영, 스태프 가이드로 흐름 관리
- **토큰 만료/유실** → TTL 관리, 스태프 수동 재발급 절차, 네트워크 실패 시 로컬 QR(무서버) 플로우 백업
